<?phpnamespace App\Controllers;use App\Controllers\BaseController;use App\Models\NvrModel;use App\Libraries\Shinobi;use Config\Database;class Videos extends BaseController{    public function index()    {        if (!session('isLoggedIn')) return redirect()->to('/login');        $db     = Database::connect();        $role   = session('role') ?? 'user';        $userId = (int) (session('user_id') ?? 0);        $nvrs = (new NvrModel())            ->where('is_active', 1)            ->orderBy('name', 'ASC')            ->findAll();        // Datang dari dashboard?        $nvrId = (int) ($this->request->getGet('nvr_id') ?? 0);        $mon   = trim((string) ($this->request->getGet('mon') ?? ''));        $monitors = [];        if ($nvrId && $mon !== '') {            $nvr = (new NvrModel())->find($nvrId);            if ($nvr) {                $cli = new Shinobi();                $res = $cli->getMonitors($nvr['base_url'], $nvr['api_key'], $nvr['group_key']);                if (($res['ok'] ?? false) && is_array($res['data'])) {                    $monitors = $cli->normalizeMonitors($res['data']);                    // ?? Filter kamera sesuai user                    if ($role === 'user' && $userId > 0) {                        $allowed = $db->table('user_dashcams')                            ->select('monitor_id')                            ->where('user_id', $userId)                            ->get()                            ->getResultArray();                        $allowedIds = array_column($allowed, 'monitor_id');                        $monitors = array_values(array_filter($monitors, fn($m) => in_array($m['mid'], $allowedIds)));                    }                }            }        } else {            $nvrId = 0;            $mon   = '';        }        return view('layout/main', [            'title'   => 'Videos',            'content' => view('videos/index', [                'nvrs'     => $nvrs,                'nvrId'    => $nvrId,                'mon'      => $mon,                'monitors' => $monitors,            ]),        ]);    }    // AJAX: ambil daftar monitor saat user pilih NVR    public function monitors()    {        if (!session('isLoggedIn')) {            return $this->response->setJSON(['ok' => false, 'items' => []]);        }        $db     = Database::connect();        $role   = session('role') ?? 'user';        $userId = (int) (session('user_id') ?? 0);        $nvrId = (int) $this->request->getGet('nvr_id');        if (!$nvrId) return $this->response->setJSON(['ok' => true, 'items' => []]);        $nvr = (new NvrModel())->find($nvrId);        if (!$nvr) return $this->response->setJSON(['ok' => true, 'items' => []]);        $cli = new Shinobi();        $res = $cli->getMonitors($nvr['base_url'], $nvr['api_key'], $nvr['group_key']);        $items = ($res['ok'] ?? false) ? $cli->normalizeMonitors($res['data']) : [];        // ?? Filter kamera sesuai user        if ($role === 'user' && $userId > 0) {            $allowed = $db->table('user_dashcams')                ->select('monitor_id')                ->where('user_id', $userId)                ->get()                ->getResultArray();            $allowedIds = array_column($allowed, 'monitor_id');            $items = array_values(array_filter($items, fn($m) => in_array($m['mid'], $allowedIds)));        }        return $this->response->setJSON(['ok' => true, 'items' => $items]);    }    // Data video: ambil dari Shinobi API via range waktu    public function data()    {        if (!session('isLoggedIn')) {            return $this->response->setJSON(['ok' => false, 'error' => 'unauthorized']);        }        $db     = Database::connect();        $role   = session('role') ?? 'user';        $userId = (int) (session('user_id') ?? 0);        $nvrId = (int) $this->request->getGet('nvr_id');        $mon   = trim((string) $this->request->getGet('mon'));        $start = (int) $this->request->getGet('start'); // epoch ms        $end   = (int) $this->request->getGet('end');   // epoch ms        if (!$nvrId || $mon === '') {            return $this->response->setJSON(['ok' => false, 'error' => 'missing params']);        }        // ?? Validasi user biasa hanya boleh akses kamera miliknya        if ($role === 'user' && $userId > 0) {            $allowed = $db->table('user_dashcams')                ->select('monitor_id')                ->where('user_id', $userId)                ->get()                ->getResultArray();            $allowedIds = array_column($allowed, 'monitor_id');            if (!in_array($mon, $allowedIds)) {                return $this->response->setJSON(['ok' => false, 'error' => 'unauthorized camera']);            }        }        $nvr = (new NvrModel())->find($nvrId);        if (!$nvr) {            return $this->response->setJSON(['ok' => false, 'error' => 'nvr not found']);        }        // ISO UTC – sesuai dokumen Shinobi        $iso = 'Y-m-d\TH:i:s';        $startIso = gmdate($iso, (int) floor($start / 1000));        $endIso   = gmdate($iso, (int) floor($end / 1000));        $cli = new Shinobi();        $res = $cli->getVideosRange(            $nvr['base_url'],            $nvr['api_key'],            $nvr['group_key'],            $mon,            $startIso,            $endIso,            null,            null,            false        );        if (!($res['ok'] ?? false) || !is_array($res['data'])) {            return $this->response->setJSON(['ok' => false, 'status' => $res['code'] ?? 500, 'data' => []]);        }        $payload = $res['data'];        $list = $payload['videos'] ?? $payload;        if (!is_array($list)) $list = [];        $base = rtrim($nvr['base_url'], '/');        $rows = [];        foreach ($list as $v) {            $href = (string) ($v['href'] ?? '');            if ($href === '') continue;            $filename = (string) ($v['filename'] ?? basename($href));            $size     = (int) ($v['size'] ?? 0);            $full     = $base . $href;            $rows[] = [                'name'     => $filename,                'size'     => $size,                'play'     => $full,                'download' => $full,            ];        }        // urutkan terbaru        usort($rows, fn($a, $b) => strcmp($b['name'], $a['name']));        return $this->response->setJSON(['ok' => true, 'data' => $rows]);    }}