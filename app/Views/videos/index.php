<?php$nvrs     = $nvrs ?? [];$nvrId    = (int)($nvrId ?? 0);$mon      = $mon ?? '';$monitors = $monitors ?? [];?><link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css"><style>.v-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0 16px}.v-table{width:100%;border-collapse:collapse}.v-table th,.v-table td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}.v-modal-back{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}.v-modal{width:min(1100px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.5)}.v-modal .v-head{position:relative;text-align:center;padding:14px 48px;border-bottom:1px solid #1f2937}.v-modal .v-close{position:absolute;right:10px;top:10px}.v-modal .v-body{padding:18px}.v-pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:#7c3aed;border:none;color:#fff;font-weight:700;cursor:pointer}</style><h2 style="margin:14px 0 6px">Videos</h2><div class="v-toolbar">  <select id="nvrSel">    <?php foreach ($nvrs as $n): ?>      <option value="<?= (int)$n['id'] ?>" <?= ((int)$nvrId===(int)$n['id'])?'selected':'' ?>>        <?= esc($n['name']) ?>      </option>    <?php endforeach; ?>  </select>  <select id="monSel">    <?php if ($monitors): ?>      <?php foreach ($monitors as $m): ?>        <option value="<?= esc($m['mid']) ?>" <?= ($mon && $mon===$m['mid'])?'selected':'' ?>>          <?= esc($m['mid'] . ' — ' . $m['name']) ?>        </option>      <?php endforeach; ?>    <?php else: ?>      <option value="">(pilih NVR)</option>    <?php endif; ?>  </select>  <label>Start</label><input id="start" style="min-width:230px">  <label>End</label><input id="end" style="min-width:230px">  <button id="apply" class="v-pill">Apply</button></div><table class="v-table" id="tbl">  <thead>    <tr>      <th>Waktu (filename)</th>      <th>Size</th>      <th>Aksi</th>    </tr>  </thead>  <tbody>    <tr><td colspan="3" style="color:#94a3b8">Pilih NVR & kamera.</td></tr>  </tbody></table><div id="vModalBack" class="v-modal-back">  <div class="v-modal">    <div class="v-head">      <div id="vTitle" style="font-weight:600"></div>      <button class="v-close v-pill" id="vClose">Close</button>    </div>    <div class="v-body">      <video id="vPlayer" controls style="width:100%;max-height:70vh;background:#000;border-radius:12px;border:1px solid #1f2937"></video>      <div id="vLink" style="margin-top:8px;color:#9ca3af;font-size:14px;word-break:break-all"></div>    </div>  </div></div><script src="https://unpkg.com/flatpickr"></script><script>const qs=s=>document.querySelector(s);const nvrSel=qs('#nvrSel'), monSel=qs('#monSel'), tb=qs('#tbl tbody');flatpickr("#start",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date(Date.now()-3*24*3600*1000)});flatpickr("#end",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date()});// load monitors saat NVR gantinvrSel.addEventListener('change', async ()=>{  const id = nvrSel.value;  monSel.innerHTML = '<option>Loading…</option>';  const r = await fetch('/videos/monitors?nvr_id='+encodeURIComponent(id));  const j = await r.json().catch(()=>({ok:false,items:[]}));  monSel.innerHTML='';  if(!j.ok){ monSel.innerHTML='<option value="">(error)</option>'; return; }  j.items.forEach(m=>{    const opt=document.createElement('option');    opt.value=m.mid; opt.textContent=`${m.mid} — ${m.name}`;    monSel.appendChild(opt);  });});// load datafunction toMs(s){ return Date.parse(s); }async function loadData(){  const nvr_id=nvrSel.value, mon=monSel.value;  if(!nvr_id || !mon){ tb.innerHTML='<tr><td colspan="3" style="color:#94a3b8">Pilih NVR & kamera.</td></tr>'; return; }  const start=toMs(qs('#start').value), end=toMs(qs('#end').value);  const r = await fetch('/videos/data?'+new URLSearchParams({nvr_id,mon,start,end}).toString());  const j = await r.json().catch(()=>({ok:false,data:[]}));  const rows=j.data||[];  tb.innerHTML = rows.length ? '' : '<tr><td colspan="3" style="color:#94a3b8">Tidak ada file pada rentang waktu tersebut.</td></tr>';  rows.forEach(row=>{    const tr=document.createElement('tr');    tr.innerHTML = `      <td>${row.name}</td>      <td>${row.size||''}</td>      <td><a href="#" data-play="${row.play}">Play</a> | <a href="${row.download}" target="_blank" rel="noopener">Download</a></td>`;    tr.querySelector('a[data-play]').addEventListener('click',(e)=>{e.preventDefault();openPlayer(row.play);});    tb.appendChild(tr);  });}qs('#apply').addEventListener('click', loadData);// Modal playerconst back=qs('#vModalBack'), v=qs('#vPlayer'), ttl=qs('#vTitle'), link=qs('#vLink');function openPlayer(url){  ttl.textContent = `${nvrSel.options[nvrSel.selectedIndex].text} — ${monSel.value}`;  v.src=url; v.currentTime=0; v.play().catch(()=>{});  link.textContent=url;  back.style.display='flex';}qs('#vClose').addEventListener('click',()=>{v.pause();v.removeAttribute('src');v.load();back.style.display='none';});back.addEventListener('click',(e)=>{if(e.target===back)qs('#vClose').click();});// Auto-run: kalau datang dari dashboard (mon terisi), langsung load; kalau tidak, user klik Apply.<?php if ($mon): ?>  window.addEventListener('DOMContentLoaded', loadData);<?php endif; ?></script>