<?php/** * Vars: * $nvrs: [[id,name,base_url,...],...] * $nvr_id: active nvr id * $mon: selected monitor id (string) * $monitors: from Shinobi->normalizeMonitors: [['mid','name'],...] * $startDefault, $endDefault: "Y-m-d H:i:s" */?><link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css"><style>  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 16px}  .toolbar select, .toolbar input{padding:8px 10px;border-radius:10px;border:1px solid #2b3445;background:#0f1420;color:#e5e7eb}  .toolbar button{padding:8px 14px;border-radius:12px;border:none;background:#7c3aed;font-weight:700;color:#fff;cursor:pointer}  .table{width:100%;border-collapse:collapse;margin-top:8px}  .table th,.table td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}  .table th{color:#9aa5b1}  /* modal */  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}  .modal.show{display:flex}  .modal-card{background:#0c1220;border:1px solid #1f2937;border-radius:16px;max-width:92vw;max-height:86vh;width:1080px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 35px rgba(0,0,0,.45)}  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1f2937}  .modal-title{font-weight:700}  .modal-body{padding:12px}  .modal-body video{width:100%;max-height:70vh;background:#000;border-radius:12px;border:1px solid #1f2937}  @media (max-width: 660px){    .toolbar{gap:8px}    .toolbar select, .toolbar input{width:100%}  }</style><section>  <h2 style="margin:14px 0 10px">Videos</h2>  <div class="toolbar">    <!-- NVR -->    <select id="nvrSel">      <?php foreach ($nvrs as $n): ?>        <option value="<?= (int)$n['id'] ?>" <?= ((int)$nvr_id === (int)$n['id'])?'selected':'' ?>>          <?= esc($n['name']) ?>        </option>      <?php endforeach; ?>    </select>    <!-- Monitor -->    <select id="monSel">      <?php foreach ($monitors as $m): ?>        <option value="<?= esc($m['mid']) ?>" <?= ($mon !== '' && $mon===$m['mid'])?'selected':'' ?>>          <?= esc($m['mid']) ?> — <?= esc($m['name']) ?>        </option>      <?php endforeach; ?>    </select>    <label>Start</label>    <input id="start" value="<?= esc($startDefault) ?>" style="min-width:210px">    <label>End</label>    <input id="end" value="<?= esc($endDefault) ?>" style="min-width:210px">    <button id="apply">Apply</button>  </div>  <table class="table" id="tbl">    <thead>      <tr>        <th>Waktu</th>        <th>Dur (s)</th>        <th>Size</th>        <th>Aksi</th>      </tr>    </thead>    <tbody><tr><td colspan="4" style="color:#6b7280">Loading…</td></tr></tbody>  </table></section><!-- Modal Player --><div class="modal" id="playerModal">  <div class="modal-card">    <div class="modal-head">      <div class="modal-title" id="playerTitle">Playback</div>      <button id="playerClose" style="background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:6px 10px;border-radius:10px;cursor:pointer">Close</button>    </div>    <div class="modal-body">      <video id="playerEl" controls autoplay></video>      <p id="playerUrl" style="color:#94a3b8;margin-top:8px;word-break:break-all"></p>    </div>  </div></div><script src="https://unpkg.com/flatpickr"></script><script>  const qs  = s => document.querySelector(s);  const qsa = s => Array.from(document.querySelectorAll(s));  flatpickr("#start",{enableTime:true,dateFormat:"Y-m-d H:i:S"});  flatpickr("#end",{enableTime:true,dateFormat:"Y-m-d H:i:S"});  const tblBody   = qs('#tbl tbody');  const nvrSel    = qs('#nvrSel');  const monSel    = qs('#monSel');  // jika user ganti NVR → reload halaman supaya dropdown monitor ke-refresh (server-side fetch)  nvrSel.addEventListener('change', ()=>{    const nvr = nvrSel.value || '';    const mon = ''; // reset    location.href = `/videos?nvr_id=${encodeURIComponent(nvr)}&mon=${encodeURIComponent(mon)}`;  });  function loadData(){    const nvr   = nvrSel.value.trim();    const mon   = monSel.value.trim();    const start = qs('#start').value.trim();    const end   = qs('#end').value.trim();    if (!nvr || !mon) { tblBody.innerHTML = `<tr><td colspan="4">Pilih NVR & Monitor dulu.</td></tr>`; return; }    tblBody.innerHTML = `<tr><td colspan="4" style="color:#6b7280">Loading…</td></tr>`;    const p = new URLSearchParams({nvr_id:nvr, mon, start, end});    fetch('/videos/data?'+p.toString())      .then(r=>r.json())      .then(j=>{        if (!j.ok) { tblBody.innerHTML = `<tr><td colspan="4">Gagal mengambil data video.</td></tr>`; return; }        render(j.data || []);      })      .catch(()=>tblBody.innerHTML = `<tr><td colspan="4">Network error.</td></tr>`);  }  function render(rows){    if (!rows.length){      tblBody.innerHTML = `<tr><td colspan="4" style="color:#6b7280">Tidak ada file pada rentang waktu tersebut.</td></tr>`;      return;    }    tblBody.innerHTML = '';    for (const r of rows){      const tr = document.createElement('tr');      tr.innerHTML = `        <td>${r.start_str || ''}</td>        <td>${(r.duration ?? '')}</td>        <td>${(r.size ?? '')}</td>        <td>          <a href="#" data-url="${r.play}" class="act-play">Play</a> |          <a href="${r.download}" target="_blank" rel="noopener">Download</a>        </td>      `;      tblBody.appendChild(tr);    }    qsa('.act-play').forEach(a=>{      a.addEventListener('click', (e)=>{        e.preventDefault();        openPlayer(a.dataset.url);      });    });  }  // Modal player (center)  const modal = qs('#playerModal');  const player = qs('#playerEl');  const playerUrl = qs('#playerUrl');  const playerTitle = qs('#playerTitle');  qs('#playerClose').addEventListener('click', closePlayer);  modal.addEventListener('click', (e)=>{ if (e.target === modal) closePlayer(); });  function openPlayer(url){    // judul: [NVR-ID] — [MONITOR-ID] (ambil dari dropdown teks)    const nvrText = nvrSel.options[nvrSel.selectedIndex].textContent.trim();    const monText = monSel.options[monSel.selectedIndex].textContent.trim(); // "MID — NAME"    const mid = monText.split(' — ')[0] || monText;    playerTitle.textContent = `${nvrText} — ${mid}`;    player.src = url;    playerUrl.textContent = url;    modal.classList.add('show');    player.play().catch(()=>{});  }  function closePlayer(){    player.pause();    player.removeAttribute('src');    player.load();    modal.classList.remove('show');  }  qs('#apply').addEventListener('click', loadData);  window.addEventListener('DOMContentLoaded', loadData);  // jika datang dari dashboard: URL /videos?nvr_id=..&mon=.. → waktu default sudah auto, langsung load.</script>