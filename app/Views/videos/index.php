<?php/** @var array $nvrs *//** @var int   $nvrId *//** @var string $mon */$nvrs = $nvrs ?? [];$nvrId = (int)($nvrId ?? 0);$mon   = $mon ?? '';?><link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css"><style>.v-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0 16px}.v-table{width:100%;border-collapse:collapse}.v-table th,.v-table td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}.v-modal-back{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}.v-modal{width:min(1100px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.5)}.v-modal .v-head{position:relative;text-align:center;padding:14px 48px;border-bottom:1px solid #1f2937}.v-modal .v-close{position:absolute;right:10px;top:10px}.v-modal .v-body{padding:18px}.v-pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:#7c3aed;border:none;color:#fff;font-weight:700;cursor:pointer}</style><h2 style="margin:14px 0 6px">Videos</h2><div class="v-toolbar">  <!-- NVR -->  <select id="nvrSel">    <?php foreach ($nvrs as $n): ?>      <option value="<?= (int)$n['id'] ?>" <?= ((int)$nvrId === (int)$n['id'])?'selected':'' ?>>        <?= esc($n['name']) ?>      </option>    <?php endforeach; ?>  </select>  <!-- Monitor akan diisi via AJAX ringan (ambil dari Shinobi sekali ketika user pilih NVR) -->  <select id="monSel"><option value="">Loading…</option></select>  <label>Start</label><input id="start" style="min-width:230px">  <label>End</label><input id="end" style="min-width:230px">  <button id="apply" class="v-pill">Apply</button></div><table class="v-table" id="tbl">  <thead>  <tr>    <th>Waktu (filename)</th>    <th>Size</th>    <th>Aksi</th>  </tr>  </thead>  <tbody></tbody></table><!-- Modal Player --><div id="vModalBack" class="v-modal-back">  <div class="v-modal">    <div class="v-head">      <div id="vTitle" style="font-weight:600"></div>      <button class="v-close v-pill" id="vClose">Close</button>    </div>    <div class="v-body">      <video id="vPlayer" controls style="width:100%;max-height:70vh;background:#000;border-radius:12px;border:1px solid #1f2937"></video>      <div id="vLink" style="margin-top:8px;color:#9ca3af;font-size:14px;word-break:break-all"></div>    </div>  </div></div><script src="https://unpkg.com/flatpickr"></script><script>const qs = s => document.querySelector(s);const qsa = s => Array.from(document.querySelectorAll(s));const nvrSel = qs('#nvrSel');const monSel = qs('#monSel');const tbBody = qs('#tbl tbody');flatpickr("#start",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date(Date.now()-3*24*3600*1000)});flatpickr("#end",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date()});// ------------------ Monitors loader (simple) ------------------async function loadMonitors(){  monSel.innerHTML = '<option>Loading…</option>';  const id = nvrSel.value;  const r = await fetch('/nvrs/'+id+'/monitors'); // endpoint ringan (lihat controller Nvrs di bawah)  const j = await r.json().catch(()=>({ok:false}));  monSel.innerHTML = '';  if (!j.ok) { monSel.innerHTML = '<option value="">(error)</option>'; return; }  j.items.forEach(m=>{    const opt = document.createElement('option');    opt.value = m.mid;    opt.textContent = `${m.mid} — ${m.name}`;    monSel.appendChild(opt);  });  // preselect dari query ?mon=  const want = "<?= esc($mon) ?>";  if (want && monSel.querySelector(`option[value="${want}"]`)) monSel.value = want;}nvrSel.addEventListener('change', loadMonitors);// ------------------ Data loader ------------------function toMs(s){ return Date.parse(s); }async function loadData(){  const nvr_id = nvrSel.value;  const mon = monSel.value;  if (!nvr_id || !mon){ tbBody.innerHTML = '<tr><td colspan="3" style="color:#94a3b8">Pilih NVR & kamera.</td></tr>'; return; }  const start = toMs(qs('#start').value), end = toMs(qs('#end').value);  const p = new URLSearchParams({nvr_id, mon, start, end});  const r = await fetch('/videos/data?'+p.toString());  const j = await r.json().catch(()=>({ok:false,data:[]}));  const rows = j.data || [];  tbBody.innerHTML = rows.length    ? ''    : '<tr><td colspan="3" style="color:#94a3b8">Tidak ada file pada rentang waktu tersebut.</td></tr>';  rows.forEach(row=>{    const tr = document.createElement('tr');    tr.innerHTML = `      <td>${row.name}</td>      <td>${row.size||''}</td>      <td>        <a href="#" data-play="${row.play}">Play</a> |        <a href="${row.download}" target="_blank" rel="noopener">Download</a>      </td>`;    // play    tr.querySelector('a[data-play]').addEventListener('click', (e)=>{      e.preventDefault(); openPlayer(row.play);    });    tbBody.appendChild(tr);  });  // Simpan pilihan terakhir  localStorage.setItem('vid_last', JSON.stringify({nvr_id, mon}));}qs('#apply').addEventListener('click', loadData);// Restore pilihan + inisialisasi(async function init(){  await loadMonitors();  try{    const last = JSON.parse(localStorage.getItem('vid_last')||'{}');    if (last.nvr_id && last.nvr_id == nvrSel.value) {      if (last.mon && monSel.querySelector(`option[value="${last.mon}"]`)) monSel.value = last.mon;    }  }catch(e){}  loadData();})();// ------------------ Modal player ------------------const back = qs('#vModalBack'), v = qs('#vPlayer'), ttl = qs('#vTitle'), link = qs('#vLink');function openPlayer(url){  ttl.textContent = `${nvrSel.options[nvrSel.selectedIndex].text} — ${monSel.value}`;  v.src = url; v.currentTime = 0; v.play().catch(()=>{});  link.textContent = url;  back.style.display = 'flex';}qs('#vClose').addEventListener('click', ()=>{ v.pause(); v.removeAttribute('src'); v.load(); back.style.display='none'; });back.addEventListener('click', (e)=>{ if (e.target===back) qs('#vClose').click(); });</script>