<?php// Expect: $nvrs, $nvr_id, $mon, $start, $end$nvr_id = (int)($nvr_id ?? 0);$mon    = $mon ?? '';$start  = $start ?? '';$end    = $end ?? '';?><link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css"><style>.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 14px}select,input,button{padding:8px 10px;border-radius:10px;border:1px solid #303a52;background:#0f1420;color:#e5e7eb}button{background:#7c3aed;border:none;font-weight:700;cursor:pointer}.table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}.table th{font-weight:600}.badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#111827}.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}.modal{width:min(1100px,96vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6)}.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937}.modal .body{padding:14px 16px}</style><h2 style="margin:14px 0 6px">Videos</h2><div class="toolbar">  <!-- NVR -->  <select id="nvr">    <?php foreach (($nvrs ?? []) as $n): ?>      <option value="<?= (int)$n['id'] ?>" <?= ($nvr_id===(int)$n['id'])?'selected':'' ?>>        <?= esc($n['name']) ?> (<?= esc($n['base_url']) ?>)      </option>    <?php endforeach; ?>  </select>  <!-- Monitor list akan terisi client-side setelah load pertama -->  <select id="mon"></select>  <label>Start</label><input id="start" style="min-width:210px" value="<?= esc($start) ?>">  <label>End</label><input id="end" style="min-width:210px" value="<?= esc($end) ?>">  <button id="apply">Apply</button></div><table class="table" id="tbl">  <thead>    <tr>      <th>Waktu (filename)</th>      <th>Size</th>      <th>Aksi</th>    </tr>  </thead>  <tbody></tbody></table><!-- Modal Player --><div class="modal-backdrop" id="playerWrap">  <div class="modal">    <header>      <div id="playerTitle" style="font-weight:700"></div>      <button onclick="closePlayer()" class="btn ghost" style="padding:6px 10px;border-radius:8px;background:#111827">Close</button>    </header>    <div class="body">      <video id="vid" controls autoplay style="width:100%;max-height:70vh;border-radius:12px;border:1px solid #1f2937;background:#000"></video>      <p id="vidUrl" style="color:#94a3b8;margin-top:8px;word-break:break-all"></p>    </div>  </div></div><script src="https://unpkg.com/flatpickr"></script><script>const qs  = s => document.querySelector(s);const qsa = s => Array.from(document.querySelectorAll(s));flatpickr("#start",{enableTime:true,dateFormat:"Y-m-d H:i:S"});flatpickr("#end",{enableTime:true,dateFormat:"Y-m-d H:i:S"});const nvrSel = qs('#nvr');const monSel = qs('#mon');function fillMonitorsFromServerDefault(){  // kalau halaman datang via redirect ?nvr_id=&mon=, set value langsung  const preMon = <?= json_encode($mon) ?>;  if (preMon) {    // render satu option biar langsung jalan; list lengkap akan dimuat saat Apply    monSel.innerHTML = `<option value="${preMon}" selected>${preMon}</option>`;  }}fillMonitorsFromServerDefault();function iso(s){ return s.replace(' ', 'T'); }function loadList(){  const nvr_id = nvrSel.value;  const mon    = monSel.value;  const start  = qs('#start').value;  const end    = qs('#end').value;  if (!nvr_id || !mon) { alert('Pilih NVR dan Monitor dahulu.'); return; }  const p = new URLSearchParams({ nvr_id, mon, start, end });  fetch('/videos/data?'+p.toString())    .then(r=>r.json())    .then(j=>{      if(!j.ok){ render([]); return; }      render(j.data||[]);    })    .catch(()=> render([]));}function render(rows){  const tb = qs('#tbl tbody');  tb.innerHTML = '';  rows.forEach(r=>{    const tr = document.createElement('tr');    tr.innerHTML = `      <td>${r.name}</td>      <td>${r.size}</td>      <td>        <a href="#" data-url="${r.play}" data-title="${nvrSel.options[nvrSel.selectedIndex].text} â€” ${monSel.value} / ${r.name}" class="act-play">Play</a>        &nbsp;|&nbsp;        <a href="${r.download}" target="_blank" rel="noopener">Download</a>      </td>`;    tb.appendChild(tr);  });  qsa('.act-play').forEach(a=>{    a.addEventListener('click', e=>{      e.preventDefault();      openPlayer(a.dataset.url, a.dataset.title);    });  });}function openPlayer(url, title){  const w = qs('#playerWrap');  qs('#playerTitle').textContent = title;  qs('#vid').src = url;  qs('#vidUrl').textContent = url;  w.style.display = 'flex';}function closePlayer(){  const v = qs('#vid');  v.pause(); v.removeAttribute('src'); v.load();  qs('#playerWrap').style.display='none';}qs('#apply').addEventListener('click', loadList);window.addEventListener('DOMContentLoaded', loadList);</script>