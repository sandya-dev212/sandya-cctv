<?php  $nvr_id = (int)($nvr_id ?? 0);  $mon    = (string)($mon ?? '');?><link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css"><style>.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}select,input,button{padding:8px 10px;border-radius:10px;border:1px solid #303a52;background:#0f1420;color:#e5e7eb}button{background:#7c3aed;border:none;font-weight:700;cursor:pointer}.table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}.table th{cursor:pointer}.muted{color:#94a3b8}/* modal player (centered) */.modal-backdrop{  position:fixed; inset:0; background:rgba(0,0,0,.7);  display:none; align-items:center; justify-content:center; z-index:1000;  padding:24px;}.modal{ background:#0b1220; border:1px solid #1f2937; border-radius:14px; width:min(96vw,1200px); padding:12px }.modal video{ width:100%; max-height:72vh; background:#000; border-radius:10px }.modal-head{ display:flex; align-items:center; gap:10px; margin:6px 4px 12px }.modal-head h3{ margin:0; font-size:16px; font-weight:800 }.modal-close{ margin-left:auto; background:#111827; padding:6px 10px; border-radius:8px }</style><div class="container">  <h2 style="margin:14px 0 6px">Videos</h2>  <div class="toolbar">    <select id="nvrSel" style="min-width:260px">      <option value="">Pilih NVR…</option>      <?php foreach ($nvrs as $n): ?>        <option value="<?= (int)$n['id'] ?>" <?= $nvr_id===(int)$n['id']?'selected':'' ?>>          <?= esc($n['name']) ?>        </option>      <?php endforeach; ?>    </select>    <select id="camSel" style="min-width:360px">      <option value="">Pilih Camera…</option>    </select>  </div>  <div class="toolbar">    <label>Start</label><input id="start" style="min-width:210px">    <label>End</label><input id="end" style="min-width:210px">    <button id="apply">Apply</button>  </div>  <table class="table" id="tbl">    <thead>      <tr>        <th data-k="start">Waktu</th>        <th data-k="duration">Dur (s)</th>        <th data-k="size">Size</th>        <th>Aksi</th>      </tr>    </thead>    <tbody></tbody>  </table>  <p id="status" class="muted" style="margin-top:8px"></p></div><!-- modal --><div id="playerBackdrop" class="modal-backdrop" onclick="if(event.target===this) closePlayer();">  <div class="modal">    <div class="modal-head">      <h3 id="modalTitle">Playback</h3>      <button class="modal-close" onclick="closePlayer()">Close</button>    </div>    <video id="player" controls autoplay></video>    <div class="muted" id="playerUrl" style="margin-top:6px;word-break:break-all"></div>  </div></div><script src="https://unpkg.com/flatpickr"></script><script>const qs=s=>document.querySelector(s); const qsa=s=>Array.from(document.querySelectorAll(s));flatpickr("#start",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date(Date.now()-3*24*3600*1000)});flatpickr("#end",{enableTime:true,dateFormat:"Y-m-d H:i:S",defaultDate:new Date()});let sortKey='start', sortDir='desc', dataRows=[];function fmtISO(s){ // "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DDTHH:mm:ss"  return (s||'').trim().replace(' ', 'T');}async function loadCameras(nvrId, preselectMon){  const sel = qs('#camSel');  sel.innerHTML = '<option value="">Loading…</option>';  if(!nvrId){ sel.innerHTML='<option value="">Pilih Camera…</option>'; return; }  const r = await fetch('/videos/monitors?nvr_id='+encodeURIComponent(nvrId));  const j = await r.json().catch(()=>({ok:false,data:[],msg:'Network error'}));  sel.innerHTML = '<option value="">Pilih Camera…</option>';  if(j.ok){    for(const m of j.data){      const opt=document.createElement('option');      opt.value = m.mid;      opt.textContent = `${m.mid} — ${m.name}`;      if(preselectMon && preselectMon===m.mid) opt.selected = true;      sel.appendChild(opt);    }  }else{    qs('#status').textContent = j.msg || 'Gagal load daftar kamera dari NVR';  }}async function loadData(){  const nvrId = qs('#nvrSel').value;  const mon   = qs('#camSel').value;  if(!nvrId || !mon){ alert('Pilih NVR dan Camera dulu.'); return; }  const start = fmtISO(qs('#start').value);  const end   = fmtISO(qs('#end').value);  const p     = new URLSearchParams({ nvr_id:nvrId, mon, start, end });  qs('#status').textContent = 'Loading videos…';  const r     = await fetch('/videos/data?'+p.toString());  const j     = await r.json().catch(()=>({ok:false,data:[],error:'Network error'}));  if(!j.ok){    qs('#status').textContent = j.error ? ('Error: '+j.error) : 'Gagal mengambil data video.';    dataRows=[]; render(); return;  }  dataRows = j.data || [];  qs('#status').textContent = dataRows.length ? '' : 'Tidak ada file pada rentang waktu tersebut.';  render();}function render(){  const tb=qs('#tbl tbody'); tb.innerHTML='';  dataRows.sort((a,b)=>{    if(sortKey==='start') return (sortDir==='asc' ? a.start_ts-b.start_ts : b.start_ts-a.start_ts);    if(sortKey==='duration') return (sortDir==='asc' ? (a.duration||0)-(b.duration||0) : (b.duration||0)-(a.duration||0));    if(sortKey==='size') return (sortDir==='asc' ? (''+(a.size||'')).localeCompare(b.size||'') : (''+(b.size||'')).localeCompare(a.size||''));return 0;  });  const nvrTxt = qs('#nvrSel').selectedOptions[0]?.textContent?.trim() || '';  const camTxt = qs('#camSel').selectedOptions[0]?.textContent?.trim() || '';  for(const r of dataRows){    const tr=document.createElement('tr');    tr.innerHTML = `      <td>${r.start_str}</td>      <td>${r.duration??''}</td>      <td>${r.size??''}</td>      <td>        <a href="#" onclick="playInline('${encodeURI(r.play)}','${nvrTxt}','${camTxt}');return false;">Play</a> |        <a href="${r.download}" target="_blank">Download</a>      </td>`;    tb.appendChild(tr);  }}qsa('#tbl th[data-k]').forEach(th=>{  th.addEventListener('click',()=>{    const k=th.getAttribute('data-k');    if(sortKey===k) sortDir=(sortDir==='asc'?'desc':'asc'); else {sortKey=k; sortDir='asc';}    render();  });});qs('#apply').addEventListener('click', loadData);// Prefill dari query serverwindow.addEventListener('DOMContentLoaded', ()=>{  const nvrId = '<?= (int)$nvr_id ?>' || '';  const mon   = '<?= esc($mon) ?>' || '';  if(nvrId){    loadCameras(nvrId, mon).then(()=>{ /* siap */ });  }});/* ====== inline player (centered) ====== */let _prevOverflow = '';function playInline(url, nvrTxt, camTxt){  const bd = qs('#playerBackdrop'); const v = qs('#player');  qs('#modalTitle').textContent = (nvrTxt && camTxt) ? `${nvrTxt} — ${camTxt}` : 'Playback';  v.src = url; qs('#playerUrl').textContent = url;  _prevOverflow = document.body.style.overflow;  document.body.style.overflow = 'hidden';  bd.style.display='flex'; v.play().catch(()=>{});}function closePlayer(){  const bd = qs('#playerBackdrop'); const v = qs('#player');  v.pause(); v.removeAttribute('src'); v.load();  bd.style.display='none';  document.body.style.overflow = _prevOverflow || '';}window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePlayer(); });qs('#nvrSel').addEventListener('change', e=> loadCameras(e.target.value, null));</script>